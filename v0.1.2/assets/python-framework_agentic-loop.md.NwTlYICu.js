import{_ as p,C as l,o as i,c as o,j as a,a as n,b as h,w as e,E as r,a3 as k,a2 as c}from"./chunks/framework.x4NSJ8gp.js";const C=JSON.parse('{"title":"Agentic Loop","description":"","frontmatter":{},"headers":[],"relativePath":"python-framework/agentic-loop.md","filePath":"python-framework/agentic-loop.md"}'),d={name:"python-framework/agentic-loop.md"};function g(u,s,E,y,m,b){const t=l("Mermaid");return i(),o("div",null,[s[1]||(s[1]=a("h1",{id:"agentic-loop",tabindex:"-1"},[n("Agentic Loop "),a("a",{class:"header-anchor",href:"#agentic-loop","aria-label":'Permalink to "Agentic Loop"'},"​")],-1)),s[2]||(s[2]=a("p",null,"The agentic loop is the reasoning mechanism that enables agents to use tools and delegate tasks iteratively until producing a final response.",-1)),s[3]||(s[3]=a("h2",{id:"how-it-works",tabindex:"-1"},[n("How It Works "),a("a",{class:"header-anchor",href:"#how-it-works","aria-label":'Permalink to "How It Works"'},"​")],-1)),(i(),h(k,null,{default:e(()=>[r(t,{id:"mermaid-9",class:"mermaid",graph:"flowchart%20TB%0A%20%20%20%20start%5B%221.%20Build%20System%20Prompt%3Cbr%2F%3E%E2%80%A2%20Base%20instructions%3Cbr%2F%3E%E2%80%A2%20Available%20tools%3Cbr%2F%3E%E2%80%A2%20Available%20agents%22%5D%0A%20%20%20%20%0A%20%20%20%20llm%5B%222.%20Send%20to%20LLM%3Cbr%2F%3ESystem%20prompt%20%2B%20conversation%20history%22%5D%0A%20%20%20%20%0A%20%20%20%20parse%5B%223.%20Parse%20Response%3Cbr%2F%3E%E2%80%A2%20Check%20for%20tool_call%20block%3Cbr%2F%3E%E2%80%A2%20Check%20for%20delegate%20block%22%5D%0A%20%20%20%20%0A%20%20%20%20tool%7B%22Tool%20Call%3F%22%7D%0A%20%20%20%20delegate%7B%22Delegation%3F%22%7D%0A%20%20%20%20%0A%20%20%20%20exec_tool%5B%22Execute%20tool%22%5D%0A%20%20%20%20exec_delegate%5B%22Invoke%20agent%22%5D%0A%20%20%20%20%0A%20%20%20%20add%5B%224.%20Add%20Result%20to%20Conversation%22%5D%0A%20%20%20%20%0A%20%20%20%20final%5B%225.%20No%20Action%20%E2%86%92%20Return%20Final%20Response%22%5D%0A%20%20%20%20%0A%20%20%20%20start%20--%3E%20llm%0A%20%20%20%20llm%20--%3E%20parse%0A%20%20%20%20parse%20--%3E%20tool%0A%20%20%20%20tool%20--%3E%7CYes%7C%20exec_tool%0A%20%20%20%20tool%20--%3E%7CNo%7C%20delegate%0A%20%20%20%20delegate%20--%3E%7CYes%7C%20exec_delegate%0A%20%20%20%20delegate%20--%3E%7CNo%7C%20final%0A%20%20%20%20exec_tool%20--%3E%20add%0A%20%20%20%20exec_delegate%20--%3E%20add%0A%20%20%20%20add%20--%3E%20llm%0A"})]),fallback:e(()=>[...s[0]||(s[0]=[n(" Loading... ",-1)])]),_:1})),s[4]||(s[4]=c(`<h2 id="configuration" tabindex="-1">Configuration <a class="header-anchor" href="#configuration" aria-label="Permalink to &quot;Configuration&quot;">​</a></h2><p>The agentic loop is controlled by the <code>max_steps</code> parameter passed to the Agent:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">agent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Agent(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;my-agent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    model_api</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model_api,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    max_steps</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Maximum loop iterations</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="max-steps" tabindex="-1">max_steps <a class="header-anchor" href="#max-steps" aria-label="Permalink to &quot;max_steps&quot;">​</a></h3><p>Prevents infinite loops. When reached, returns message:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&quot;Reached maximum reasoning steps (5)&quot;</span></span></code></pre></div><p><strong>Guidelines:</strong></p><ul><li>Simple queries: 2-3 steps</li><li>Tool-using tasks: 5 steps (default)</li><li>Complex multi-step tasks: 10+ steps</li></ul><h2 id="system-prompt-construction" tabindex="-1">System Prompt Construction <a class="header-anchor" href="#system-prompt-construction" aria-label="Permalink to &quot;System Prompt Construction&quot;">​</a></h2><p>The agent builds an enhanced system prompt:</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _build_system_prompt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    parts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.instructions]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.mcp_clients:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        tools_info </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._get_tools_description()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        parts.append(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">## Available Tools</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tools_info)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        parts.append(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">TOOLS_INSTRUCTIONS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.sub_agents:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        agents_info </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._get_agents_description()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        parts.append(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">## Available Agents for Delegation</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> agents_info)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        parts.append(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AGENT_INSTRUCTIONS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.join(parts)</span></span></code></pre></div><h3 id="tool-instructions-template" tabindex="-1">Tool Instructions Template <a class="header-anchor" href="#tool-instructions-template" aria-label="Permalink to &quot;Tool Instructions Template&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>To use a tool, respond with a JSON block in this exact format:</span></span>
<span class="line"><span>\`\`\`tool_call</span></span>
<span class="line"><span>{&quot;tool&quot;: &quot;tool_name&quot;, &quot;arguments&quot;: {&quot;arg1&quot;: &quot;value1&quot;}}</span></span></code></pre></div><p>Wait for the tool result before providing your final answer.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span></span></span>
<span class="line"><span>### Delegation Instructions Template</span></span></code></pre></div><p>To delegate a task to another agent, respond with:</p><div class="language-delegate vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">delegate</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{&quot;agent&quot;: &quot;agent_name&quot;, &quot;task&quot;: &quot;task description&quot;}</span></span></code></pre></div><p>Wait for the agent&#39;s response before providing your final answer.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span></span></span>
<span class="line"><span>## Response Parsing</span></span>
<span class="line"><span></span></span>
<span class="line"><span>### Tool Call Detection</span></span>
<span class="line"><span></span></span>
<span class="line"><span>\`\`\`python</span></span>
<span class="line"><span>def _parse_tool_call(self, content: str) -&gt; Optional[Dict[str, Any]]:</span></span>
<span class="line"><span>    match = re.search(r&#39;\`\`\`tool_call\\s*\\n({.*?})\\s*\\n\`\`\`&#39;, content, re.DOTALL)</span></span>
<span class="line"><span>    if match:</span></span>
<span class="line"><span>        return json.loads(match.group(1))</span></span>
<span class="line"><span>    return None</span></span></code></pre></div><p><strong>Example LLM Response:</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>I&#39;ll use the calculator tool to compute this.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>\`\`\`tool_call</span></span>
<span class="line"><span>{&quot;tool&quot;: &quot;calculate&quot;, &quot;arguments&quot;: {&quot;expression&quot;: &quot;2 + 2&quot;}}</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span></span></span>
<span class="line"><span>### Delegation Detection</span></span>
<span class="line"><span></span></span>
<span class="line"><span>\`\`\`python</span></span>
<span class="line"><span>def _parse_delegation(self, content: str) -&gt; Optional[Dict[str, Any]]:</span></span>
<span class="line"><span>    match = re.search(r&#39;\`\`\`delegate\\s*\\n({.*?})\\s*\\n\`\`\`&#39;, content, re.DOTALL)</span></span>
<span class="line"><span>    if match:</span></span>
<span class="line"><span>        return json.loads(match.group(1))</span></span>
<span class="line"><span>    return None</span></span></code></pre></div><p><strong>Example LLM Response:</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>This is a research task, I&#39;ll delegate to the researcher agent.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>\`\`\`delegate</span></span>
<span class="line"><span>{&quot;agent&quot;: &quot;researcher&quot;, &quot;task&quot;: &quot;Find information about quantum computing&quot;}</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span></span></span>
<span class="line"><span>## Execution Flow</span></span>
<span class="line"><span></span></span>
<span class="line"><span>### Tool Execution</span></span>
<span class="line"><span></span></span>
<span class="line"><span>1. Parse tool name and arguments from \`tool_call\` block</span></span>
<span class="line"><span>2. Log \`tool_call\` event to memory</span></span>
<span class="line"><span>3. Execute tool via MCP client</span></span>
<span class="line"><span>4. Log \`tool_result\` event to memory</span></span>
<span class="line"><span>5. Add result to conversation</span></span>
<span class="line"><span>6. Continue loop</span></span>
<span class="line"><span></span></span>
<span class="line"><span>### Delegation Execution</span></span>
<span class="line"><span></span></span>
<span class="line"><span>1. Parse agent name and task from \`delegate\` block</span></span>
<span class="line"><span>2. Log \`delegation_request\` event to memory</span></span>
<span class="line"><span>3. Invoke remote agent via A2A protocol</span></span>
<span class="line"><span>4. Log \`delegation_response\` event to memory</span></span>
<span class="line"><span>5. Add response to conversation</span></span>
<span class="line"><span>6. Continue loop</span></span>
<span class="line"><span></span></span>
<span class="line"><span>## Memory Events</span></span>
<span class="line"><span></span></span>
<span class="line"><span>The loop logs events for debugging and verification:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>\`\`\`python</span></span>
<span class="line"><span># After tool execution</span></span>
<span class="line"><span>events = await agent.memory.get_session_events(session_id)</span></span>
<span class="line"><span># Events: [user_message, tool_call, tool_result, agent_response]</span></span>
<span class="line"><span></span></span>
<span class="line"><span># After delegation</span></span>
<span class="line"><span>events = await agent.memory.get_session_events(session_id)</span></span>
<span class="line"><span># Events: [user_message, delegation_request, delegation_response, agent_response]</span></span></code></pre></div><h2 id="testing-with-mock-responses" tabindex="-1">Testing with Mock Responses <a class="header-anchor" href="#testing-with-mock-responses" aria-label="Permalink to &quot;Testing with Mock Responses&quot;">​</a></h2><p>Set <code>DEBUG_MOCK_RESPONSES</code> environment variable to test loop behavior deterministically:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Test tool calling</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DEBUG_MOCK_RESPONSES</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;[&quot;I will use the echo tool.\\n\\n\`\`\`tool_call\\n{\\&quot;tool\\&quot;: \\&quot;echo\\&quot;, \\&quot;arguments\\&quot;: {\\&quot;text\\&quot;: \\&quot;hello\\&quot;}}\\n\`\`\`&quot;, &quot;The echo returned: hello&quot;]&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Test delegation</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DEBUG_MOCK_RESPONSES</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;[&quot;I will delegate to the researcher.\\n\\n\`\`\`delegate\\n{\\&quot;agent\\&quot;: \\&quot;researcher\\&quot;, \\&quot;task\\&quot;: \\&quot;Find quantum computing info\\&quot;}\\n\`\`\`&quot;, &quot;Based on the research, quantum computing uses qubits.&quot;]&#39;</span></span></code></pre></div><p>For Kubernetes E2E tests, configure via the Agent CRD:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    env</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">DEBUG_MOCK_RESPONSES</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;[&quot;\`\`\`delegate\\n{\\&quot;agent\\&quot;: \\&quot;worker\\&quot;, \\&quot;task\\&quot;: \\&quot;process data\\&quot;}\\n\`\`\`&quot;, &quot;Done.&quot;]&#39;</span></span></code></pre></div><h2 id="best-practices" tabindex="-1">Best Practices <a class="header-anchor" href="#best-practices" aria-label="Permalink to &quot;Best Practices&quot;">​</a></h2><ol><li><strong>Set appropriate max_steps</strong> - Too low may truncate reasoning, too high wastes resources</li><li><strong>Clear instructions</strong> - Tell the LLM when to use tools vs. respond directly</li><li><strong>Test with mocks</strong> - Verify loop behavior without LLM variability</li><li><strong>Monitor events</strong> - Use memory endpoints to debug complex flows</li><li><strong>Handle errors gracefully</strong> - Tool failures are fed back to the loop for recovery</li></ol>`,32))])}const F=p(d,[["render",g]]);export{C as __pageData,F as default};
