name: Run Tests

on:
  workflow_call:
    inputs:
      run-e2e:
        description: 'Run E2E tests'
        required: false
        type: boolean
        default: true
      run-unit:
        description: 'Run unit tests'
        required: false
        type: boolean
        default: true

env:
  KIND_CLUSTER_NAME: kaos-e2e
  CI: true
  KIND_CLUSTER: true
  REGISTRY: axsauze

jobs:
  # Unit tests (Python + Go)
  unit-tests:
    if: inputs.run-unit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: operator/go.mod
          cache-dependency-path: operator/go.sum

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Go tools
        run: |
          go install sigs.k8s.io/controller-tools/cmd/controller-gen@latest
          go install sigs.k8s.io/controller-runtime/tools/setup-envtest@latest

      - name: Run Go tests
        working-directory: operator
        run: make test-unit

      - name: Install Python dependencies
        working-directory: python
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Python tests
        working-directory: python
        run: python -m pytest tests/ -v

  # E2E tests (sharded)
  e2e-tests:
    if: inputs.run-e2e
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        shard:
          - name: core
            files: "e2e/test_base_func_e2e.py e2e/test_modelapi_e2e.py"
          - name: mcp
            files: "e2e/test_mcp_tools_e2e.py"
          - name: multi-agent
            files: "e2e/test_agentic_loop_e2e.py e2e/test_multi_agent_e2e.py"
    name: E2E (${{ matrix.shard.name }})
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: operator/go.mod
          cache-dependency-path: operator/go.sum

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create KIND cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: ${{ env.KIND_CLUSTER_NAME }}

      - name: Install Gateway API and Envoy Gateway
        run: ./operator/hack/install-gateway.sh

      - name: Install MetalLB for LoadBalancer support
        run: ./operator/hack/install-metallb.sh

      - name: Set image tags from VERSION
        run: |
          VERSION=$(cat VERSION)
          echo "OPERATOR_TAG=$VERSION" >> $GITHUB_ENV
          echo "AGENT_TAG=$VERSION" >> $GITHUB_ENV
          echo "Using VERSION: $VERSION"

      - name: Build operator image
        uses: docker/build-push-action@v6
        with:
          context: ./operator
          load: true
          tags: ${{ env.REGISTRY }}/kaos-operator:${{ env.OPERATOR_TAG }}
          cache-from: type=gha,scope=operator-e2e
          cache-to: type=gha,scope=operator-e2e,mode=max
          github-token: ${{ github.token }}

      - name: Build agent image
        uses: docker/build-push-action@v6
        with:
          context: ./python
          load: true
          tags: ${{ env.REGISTRY }}/kaos-agent:${{ env.AGENT_TAG }}
          cache-from: type=gha,scope=agent-e2e
          cache-to: type=gha,scope=agent-e2e,mode=max
          github-token: ${{ github.token }}

      - name: Build LiteLLM image
        uses: docker/build-push-action@v6
        with:
          context: ./operator/hack
          file: ./operator/hack/Dockerfile.litellm
          load: true
          tags: ghcr.io/berriai/litellm:main-stable
          cache-from: type=gha,scope=litellm-e2e
          cache-to: type=gha,scope=litellm-e2e,mode=max
          github-token: ${{ github.token }}

      - name: Pull Ollama image
        run: docker pull alpine/ollama:latest

      - name: Tag MCP server image
        run: |
          docker tag ${{ env.REGISTRY }}/kaos-agent:${{ env.AGENT_TAG }} ${{ env.REGISTRY }}/kaos-mcp-server:${{ env.AGENT_TAG }}

      - name: Load images into KIND
        run: |
          kind load docker-image ${{ env.REGISTRY }}/kaos-operator:${{ env.OPERATOR_TAG }} --name ${{ env.KIND_CLUSTER_NAME }}
          kind load docker-image ${{ env.REGISTRY }}/kaos-agent:${{ env.AGENT_TAG }} --name ${{ env.KIND_CLUSTER_NAME }}
          kind load docker-image ${{ env.REGISTRY }}/kaos-mcp-server:${{ env.AGENT_TAG }} --name ${{ env.KIND_CLUSTER_NAME }}
          kind load docker-image ghcr.io/berriai/litellm:main-stable --name ${{ env.KIND_CLUSTER_NAME }}
          kind load docker-image alpine/ollama:latest --name ${{ env.KIND_CLUSTER_NAME }}

      - name: Install KAOS operator
        run: make -C operator kind-e2e-install-kaos

      - name: Run E2E tests (${{ matrix.shard.name }})
        run: |
          cd operator/tests
          source .venv/bin/activate 2>/dev/null || (uv venv && source .venv/bin/activate && uv pip install -e .)
          
          # Set up port-forward to Gateway
          GATEWAY_SVC=$(kubectl get svc -n envoy-gateway-system -l "gateway.envoyproxy.io/owning-gateway-name=kaos-gateway" -o jsonpath='{.items[0].metadata.name}')
          kubectl port-forward -n envoy-gateway-system "svc/${GATEWAY_SVC}" 8888:80 &
          sleep 5
          
          export GATEWAY_URL="http://localhost:8888"
          export OPERATOR_MANAGED_EXTERNALLY=1
          export KIND_CLUSTER=true
          
          # Run tests for this shard (2 workers on 2-core runner)
          uv run pytest ${{ matrix.shard.files }} -v -n 2 --dist loadscope

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Cluster Info ==="
          kubectl cluster-info
          echo "=== All Namespaces ==="
          kubectl get ns
          echo "=== Operator Logs ==="
          kubectl logs -n kaos-system -l app.kubernetes.io/name=kaos-operator --tail=100 || true
          echo "=== All Pods ==="
          kubectl get pods -A
          echo "=== Events ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -50
