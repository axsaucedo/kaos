name: E2E Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

env:
  KIND_CLUSTER_NAME: agentic-e2e
  REGISTRY_NAME: kind-registry
  REGISTRY_PORT: 5001
  # Image versions - single source of truth (also set in hack/build-push-images.sh)
  OPERATOR_TAG: dev
  AGENT_TAG: dev
  LITELLM_VERSION: v1.56.5
  OLLAMA_TAG: latest

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: operator/go.mod
          cache-dependency-path: operator/go.sum

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Create KIND cluster with registry
        uses: helm/kind-action@v1
        with:
          cluster_name: ${{ env.KIND_CLUSTER_NAME }}
          registry: true
          registry_name: ${{ env.REGISTRY_NAME }}
          registry_port: ${{ env.REGISTRY_PORT }}

      - name: Install Gateway API and Envoy Gateway
        run: ./hack/install-gateway.sh

      - name: Install MetalLB for LoadBalancer support
        run: ./hack/install-metallb.sh

      - name: Install Python test dependencies
        run: |
          cd operator/tests
          uv venv
          uv pip install -e ".[dev]"

      - name: Generate Helm values and build images
        env:
          REGISTRY: localhost:${{ env.REGISTRY_PORT }}
        run: |
          # Generate Helm values file using shared script
          ./hack/update-kind-e2e-values.sh
          
          # Build and push all images using shared script
          ./hack/build-push-images.sh

      - name: Install operator and run E2E tests
        env:
          REGISTRY: localhost:${{ env.REGISTRY_PORT }}
        run: |
          # Install operator
          echo "Installing operator..."
          kubectl create namespace agentic-e2e-system
          kubectl apply --server-side -f operator/config/crd/bases
          helm upgrade --install agentic-e2e operator/chart \
              --namespace agentic-e2e-system \
              -f hack/kind-e2e-values.yaml \
              --set gatewayAPI.enabled=true \
              --set gatewayAPI.createGateway=true \
              --set gatewayAPI.gatewayClassName=envoy-gateway \
              --skip-crds \
              --wait --timeout 120s
          
          # Wait for Gateway
          echo "Waiting for Gateway..."
          for i in {1..30}; do
              STATUS=$(kubectl get gateway agentic-gateway -n agentic-e2e-system -o jsonpath='{.status.conditions[?(@.type=="Programmed")].status}' 2>/dev/null || echo "")
              if [ "$STATUS" = "True" ]; then
                  echo "Gateway is programmed!"
                  break
              fi
              sleep 2
          done
          
          # Start port-forward
          GATEWAY_SVC=$(kubectl get svc -n envoy-gateway-system -l "gateway.envoyproxy.io/owning-gateway-name=agentic-gateway" -o jsonpath='{.items[0].metadata.name}')
          kubectl port-forward -n envoy-gateway-system "svc/${GATEWAY_SVC}" 8888:80 &
          sleep 5
          
          # Run tests
          cd operator/tests
          source .venv/bin/activate
          export HELM_VALUES_FILE=${{ github.workspace }}/hack/kind-e2e-values.yaml
          export GATEWAY_URL=http://localhost:8888
          export OPERATOR_MANAGED_EXTERNALLY=1
          make test

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Cluster Info ==="
          kubectl cluster-info
          echo "=== All Namespaces ==="
          kubectl get ns
          echo "=== Operator Logs ==="
          kubectl logs -n agentic-e2e-system -l app.kubernetes.io/name=agentic-operator --tail=100 || true
          echo "=== All Pods ==="
          kubectl get pods -A
          echo "=== Events ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -50
