name: E2E Tests

on:
  pull_request:
    branches: [main]
    paths:
      - 'operator/**'
      - 'python/**'
      - '.github/workflows/e2e-tests.yaml'
  push:
    branches: [main]
    paths:
      - 'operator/**'
      - 'python/**'
      - '.github/workflows/e2e-tests.yaml'
  workflow_dispatch:

env:
  KIND_CLUSTER_NAME: kaos-e2e
  CI: true
  KIND_CLUSTER: true
  REGISTRY: kind-local
  OPERATOR_TAG: dev
  AGENT_TAG: dev

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        shard:
          - name: core
            files: "e2e/test_base_func_e2e.py e2e/test_modelapi_e2e.py"
          - name: mcp
            files: "e2e/test_mcp_tools_e2e.py"
          - name: multi-agent
            files: "e2e/test_agentic_loop_e2e.py e2e/test_multi_agent_e2e.py"
    name: E2E (${{ matrix.shard.name }})
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: operator/go.mod
          cache-dependency-path: operator/go.sum

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      # Set up Docker Buildx for better caching support
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create KIND cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: ${{ env.KIND_CLUSTER_NAME }}

      - name: Install Gateway API and Envoy Gateway
        run: ./operator/hack/install-gateway.sh

      - name: Install MetalLB for LoadBalancer support
        run: ./operator/hack/install-metallb.sh

      # Build images with GHA cache for faster CI builds
      - name: Build operator image
        uses: docker/build-push-action@v6
        with:
          context: ./operator
          load: true
          tags: ${{ env.REGISTRY }}/kaos-operator:${{ env.OPERATOR_TAG }}
          cache-from: type=gha,scope=operator-e2e
          cache-to: type=gha,scope=operator-e2e,mode=max
          github-token: ${{ github.token }}

      - name: Build agent image
        uses: docker/build-push-action@v6
        with:
          context: ./python
          load: true
          tags: ${{ env.REGISTRY }}/kaos-agent:${{ env.AGENT_TAG }}
          cache-from: type=gha,scope=agent-e2e
          cache-to: type=gha,scope=agent-e2e,mode=max
          github-token: ${{ github.token }}

      - name: Build LiteLLM image
        uses: docker/build-push-action@v6
        with:
          context: ./operator/hack
          file: ./operator/hack/Dockerfile.litellm
          load: true
          tags: ${{ env.REGISTRY }}/litellm:v1.56.5
          cache-from: type=gha,scope=litellm-e2e
          cache-to: type=gha,scope=litellm-e2e,mode=max
          github-token: ${{ github.token }}

      - name: Pull and tag Ollama image
        run: |
          docker pull alpine/ollama:latest
          docker tag alpine/ollama:latest ${{ env.REGISTRY }}/ollama:latest

      - name: Tag MCP server image
        run: |
          docker tag ${{ env.REGISTRY }}/kaos-agent:${{ env.AGENT_TAG }} ${{ env.REGISTRY }}/kaos-mcp-server:${{ env.AGENT_TAG }}

      - name: Load images into KIND
        run: |
          kind load docker-image ${{ env.REGISTRY }}/kaos-operator:${{ env.OPERATOR_TAG }} --name ${{ env.KIND_CLUSTER_NAME }}
          kind load docker-image ${{ env.REGISTRY }}/kaos-agent:${{ env.AGENT_TAG }} --name ${{ env.KIND_CLUSTER_NAME }}
          kind load docker-image ${{ env.REGISTRY }}/kaos-mcp-server:${{ env.AGENT_TAG }} --name ${{ env.KIND_CLUSTER_NAME }}
          kind load docker-image ${{ env.REGISTRY }}/litellm:v1.56.5 --name ${{ env.KIND_CLUSTER_NAME }}
          kind load docker-image ${{ env.REGISTRY }}/ollama:latest --name ${{ env.KIND_CLUSTER_NAME }}

      - name: Install KAOS operator
        run: make -C operator kind-e2e-install-kaos

      - name: Run E2E tests (${{ matrix.shard.name }})
        run: |
          cd operator/tests
          source .venv/bin/activate 2>/dev/null || (uv venv && source .venv/bin/activate && uv pip install -e .)
          
          # Set up port-forward to Gateway
          GATEWAY_SVC=$(kubectl get svc -n envoy-gateway-system -l "gateway.envoyproxy.io/owning-gateway-name=kaos-gateway" -o jsonpath='{.items[0].metadata.name}')
          kubectl port-forward -n envoy-gateway-system "svc/${GATEWAY_SVC}" 8888:80 &
          sleep 5
          
          export GATEWAY_URL="http://localhost:8888"
          export OPERATOR_MANAGED_EXTERNALLY=1
          export KIND_CLUSTER=true
          export HELM_VALUES_FILE="$(pwd)/../hack/kind-e2e-values.yaml"
          
          # Run tests for this shard (2 workers on 2-core runner)
          uv run pytest ${{ matrix.shard.files }} -v -n 2 --dist loadscope

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Cluster Info ==="
          kubectl cluster-info
          echo "=== All Namespaces ==="
          kubectl get ns
          echo "=== Operator Logs ==="
          kubectl logs -n kaos-e2e-system -l app.kubernetes.io/name=kaos-operator --tail=100 || true
          echo "=== All Pods ==="
          kubectl get pods -A
          echo "=== Events ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -50
