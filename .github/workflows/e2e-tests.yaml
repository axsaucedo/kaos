name: E2E Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

env:
  KIND_CLUSTER_NAME: agentic-e2e
  REGISTRY_NAME: kind-registry
  REGISTRY_PORT: 5001

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: operator/go.mod
          cache-dependency-path: operator/go.sum

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Create KIND cluster with registry
        uses: helm/kind-action@v1
        with:
          cluster_name: ${{ env.KIND_CLUSTER_NAME }}
          registry: true
          registry_name: ${{ env.REGISTRY_NAME }}
          registry_port: ${{ env.REGISTRY_PORT }}

      - name: Install Gateway API and Envoy Gateway
        run: ./hack/install-gateway.sh

      - name: Build and push images
        env:
          LOCAL_REGISTRY: localhost:${{ env.REGISTRY_PORT }}
        run: |
          # Image versions (must match hack/kind-e2e-values.yaml)
          OPERATOR_TAG="dev"
          AGENT_TAG="dev"
          LITELLM_VERSION="v1.56.5"
          OLLAMA_TAG="latest"
          
          # Build project images
          docker build -t ${LOCAL_REGISTRY}/agentic-operator:${OPERATOR_TAG} operator/
          docker build -t ${LOCAL_REGISTRY}/agentic-agent:${AGENT_TAG} python/
          docker tag ${LOCAL_REGISTRY}/agentic-agent:${AGENT_TAG} ${LOCAL_REGISTRY}/agentic-mcp-server:${AGENT_TAG}
          docker push ${LOCAL_REGISTRY}/agentic-operator:${OPERATOR_TAG}
          docker push ${LOCAL_REGISTRY}/agentic-agent:${AGENT_TAG}
          docker push ${LOCAL_REGISTRY}/agentic-mcp-server:${AGENT_TAG}
          
          # Build minimal LiteLLM image from our Dockerfile
          docker build -t ${LOCAL_REGISTRY}/litellm:${LITELLM_VERSION} -f hack/Dockerfile.litellm hack/
          docker push ${LOCAL_REGISTRY}/litellm:${LITELLM_VERSION}
          
          # Pull and push Ollama image (alpine/ollama only has 'latest' tag)
          docker pull alpine/ollama:${OLLAMA_TAG}
          docker tag alpine/ollama:${OLLAMA_TAG} ${LOCAL_REGISTRY}/ollama:${OLLAMA_TAG}
          docker push ${LOCAL_REGISTRY}/ollama:${OLLAMA_TAG}

      - name: Install MetalLB for LoadBalancer support
        run: ./hack/install-metallb.sh

      - name: Install Python test dependencies
        run: |
          cd operator/tests
          uv venv
          uv pip install -e ".[dev]"

      - name: Run E2E tests
        run: |
          cd operator/tests
          source .venv/bin/activate
          export HELM_VALUES_FILE=${{ github.workspace }}/hack/kind-e2e-values.yaml
          make test

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Cluster Info ==="
          kubectl cluster-info
          echo "=== All Namespaces ==="
          kubectl get ns
          echo "=== Operator Logs ==="
          kubectl logs -n agentic-e2e-system -l app.kubernetes.io/name=agentic-operator --tail=100 || true
          echo "=== All Pods ==="
          kubectl get pods -A
          echo "=== Events ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -50
