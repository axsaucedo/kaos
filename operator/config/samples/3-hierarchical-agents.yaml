---
# Sample 3: Hierarchical Agent System
# Complex multi-level hierarchy: supervisor -> team leads -> workers
# Demonstrates toolsString for dynamic MCP tool creation
# Deploy: kubectl apply -f 3-hierarchical-agents.yaml

apiVersion: v1
kind: Namespace
metadata:
  name: kaos-hierarchy
  labels:
    app.kubernetes.io/part-of: kaos-sample-hierarchy

---
# ModelAPI: Hosted Ollama with smollm2 model
apiVersion: kaos.tools/v1alpha1
kind: ModelAPI
metadata:
  name: hierarchy-modelapi
  namespace: kaos-hierarchy
spec:
  mode: Hosted
  hostedConfig:
    model: "smollm2:135m"

---
# MCPServer: Echo tool
apiVersion: kaos.tools/v1alpha1
kind: MCPServer
metadata:
  name: hierarchy-echo-mcp
  namespace: kaos-hierarchy
spec:
  type: python-runtime
  config:
    tools:
      fromPackage: "test-mcp-echo-server"

---
# MCPServer: Calculator tool using fromString
apiVersion: kaos.tools/v1alpha1
kind: MCPServer
metadata:
  name: hierarchy-calc-mcp
  namespace: kaos-hierarchy
spec:
  type: python-runtime
  config:
    tools:
      fromString: |
        def calculate(expression: str) -> str:
            """Evaluate a mathematical expression safely."""
            try:
                # Only allow safe math operations
                allowed = set('0123456789+-*/.() ')
                if not all(c in allowed for c in expression):
                    return "Error: Invalid characters in expression"
                result = eval(expression)
                return str(result)
            except Exception as e:
                return f"Error: {str(e)}"

---
# Agent: Supervisor - top of hierarchy
apiVersion: kaos.tools/v1alpha1
kind: Agent
metadata:
  name: supervisor
  namespace: kaos-hierarchy
spec:
  modelAPI: hierarchy-modelapi
  mcpServers:
  - hierarchy-echo-mcp
  config:
    description: "Supervisor agent at top of hierarchy"
    instructions: |
      You are the supervisor. You delegate to research-lead and analysis-lead.
    reasoningLoopMaxSteps: 10
  agentNetwork:
    access:
    - research-lead
    - analysis-lead

---
# Agent: Research Lead
apiVersion: kaos.tools/v1alpha1
kind: Agent
metadata:
  name: research-lead
  namespace: kaos-hierarchy
spec:
  modelAPI: hierarchy-modelapi
  mcpServers:
  - hierarchy-echo-mcp
  config:
    description: "Research team lead"
    instructions: |
      You are the research team lead. You manage researcher-1 and researcher-2.
    reasoningLoopMaxSteps: 5
  agentNetwork:
    access:
    - researcher-1
    - researcher-2

---
# Agent: Analysis Lead
apiVersion: kaos.tools/v1alpha1
kind: Agent
metadata:
  name: analysis-lead
  namespace: kaos-hierarchy
spec:
  modelAPI: hierarchy-modelapi
  mcpServers:
  - hierarchy-calc-mcp
  config:
    description: "Analysis team lead"
    instructions: |
      You are the analysis team lead. You manage analyst-1 and have a calculator.
    reasoningLoopMaxSteps: 5
  agentNetwork:
    access:
    - analyst-1

---
# Agent: Researcher 1
apiVersion: kaos.tools/v1alpha1
kind: Agent
metadata:
  name: researcher-1
  namespace: kaos-hierarchy
spec:
  modelAPI: hierarchy-modelapi
  mcpServers:
  - hierarchy-echo-mcp
  config:
    description: "Research worker 1"
    instructions: |
      You are researcher-1. You conduct research and report to research-lead.
    reasoningLoopMaxSteps: 3

---
# Agent: Researcher 2
apiVersion: kaos.tools/v1alpha1
kind: Agent
metadata:
  name: researcher-2
  namespace: kaos-hierarchy
spec:
  modelAPI: hierarchy-modelapi
  mcpServers:
  - hierarchy-echo-mcp
  config:
    description: "Research worker 2"
    instructions: |
      You are researcher-2. You conduct research and report to research-lead.
    reasoningLoopMaxSteps: 3

---
# Agent: Analyst 1
apiVersion: kaos.tools/v1alpha1
kind: Agent
metadata:
  name: analyst-1
  namespace: kaos-hierarchy
spec:
  modelAPI: hierarchy-modelapi
  mcpServers:
  - hierarchy-calc-mcp
  config:
    description: "Analysis worker"
    instructions: |
      You are analyst-1. You perform analysis using the calculator tool.
    reasoningLoopMaxSteps: 3
